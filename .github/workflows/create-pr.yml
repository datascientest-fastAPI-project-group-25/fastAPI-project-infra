name: PR Creation - with Machine User Token
# This workflow creates a pull request from a feature or fix branch to the main branch 🚀

on:
  push:
    branches:
      - 'feat/*'
      - 'feature/*'
      - 'fix/*'
      - 'hotfix/*'

# Cancel any running workflow if new commits are pushed to the branch
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch name
        shell: bash
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Generate PR Body
        id: pr-body
        run: |
          # Get changed files between current branch and main
          changed_files=$(git diff --name-status main | grep "^[AM]" | awk '{print $2}')
          terraform_changes=$(echo "$changed_files" | grep "^terraform/" || true)
          
          # Start building the PR body
          cat << EOF > pr_body.txt
          ## Infrastructure Changes Summary

          $(if [ -n "$terraform_changes" ]; then
            echo "### 🔄 Modified Terraform Resources"
            echo ""
            echo "\`\`\`"
            echo "$terraform_changes" | sed 's/^/  /'
            echo "\`\`\`"
            echo ""
          fi)

          ### 🎯 Impact Analysis
          
          $(if [ -n "$terraform_changes" ]; then
            echo "Changes affect these infrastructure components:"
            echo ""
            for file in $terraform_changes; do
              if [[ $file == terraform/environments/* ]]; then
                env_path=${file#terraform/environments/}
                env_name=${env_path%%/*}
                echo "* \`$env_name\` environment"
              elif [[ $file == terraform/modules/* ]]; then
                module_path=${file#terraform/modules/}
                module_name=${module_path%%/*}
                echo "* \`$module_name\` module"
              fi
            done
          fi)

          ### 🔍 Review Guidelines

          Please review focusing on:
          * Infrastructure security implications
          * Cost impact and resource efficiency
          * Compliance with infrastructure standards
          * Resource naming and tagging consistency

          ### ✅ Verification Checklist

          - [ ] Infrastructure changes follow company standards
          - [ ] Resource configurations are properly documented
          - [ ] Security best practices are maintained
          - [ ] Cost implications have been assessed
          - [ ] State file implications considered

          ---
          Generated by Infrastructure CI/CD Pipeline
          EOF
          
          # Escape the content for GitHub Actions
          body="$(cat pr_body.txt)"
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          body="${body//$'\r'/'%0D'}"
          echo "BODY=$body" >> $GITHUB_ENV

      - name: Create Pull Request with GitHub CLI
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.MACHINE_USER_TOKEN }}
        run: |
          # Check if an open PR already exists from this branch to main
          existing_pr_url=$(gh pr list --head "${{ env.BRANCH_NAME }}" --base main --state open --json url --jq '.[0].url')

          if [ -n "$existing_pr_url" ]; then
            echo "Pull request already exists: $existing_pr_url"
            pr_url="$existing_pr_url"
            pr_number=$(basename "$pr_url" | cut -d'/' -f1)
            # Set outputs
            echo "pull-request-url=$pr_url" >> $GITHUB_OUTPUT
            echo "pull-request-number=$pr_number" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract type (feat/fix) from branch name
          if [[ "${{ env.BRANCH_NAME }}" == feat/* ]] || [[ "${{ env.BRANCH_NAME }}" == feature/* ]]; then
            TYPE="feat"
          elif [[ "${{ env.BRANCH_NAME }}" == fix/* ]] || [[ "${{ env.BRANCH_NAME }}" == hotfix/* ]]; then
            TYPE="fix"
          else
            TYPE="other"
          fi

          # Create PR title with emoji based on type
          if [[ "$TYPE" == "feat" ]]; then
            EMOJI="✨"
          else
            EMOJI="🔧"
          fi

          # No open PR found, create a new one
          pr_url=$(gh pr create \
            --base main \
            --head "${{ env.BRANCH_NAME }}" \
            --title "$EMOJI $TYPE: Infrastructure changes from ${{ env.BRANCH_NAME }}" \
            --body "${{ env.BODY }}")

          echo "PR URL: $pr_url"

          # Extract PR number from URL
          pr_number=$(basename "$pr_url" | cut -d'/' -f1)

          # Set outputs
          echo "pull-request-url=$pr_url" >> $GITHUB_OUTPUT
          echo "pull-request-number=$pr_number" >> $GITHUB_OUTPUT

      - name: PR Details
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "PR #${{ steps.create-pr.outputs.pull-request-number }} created: ${{ steps.create-pr.outputs.pull-request-url }}"